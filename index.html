<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Crisis Response Agent - TiDB AgentX</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.min.css" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: #333;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }

        .header {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            padding: 30px;
            margin-bottom: 30px;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
            text-align: center;
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        .header h1 {
            font-size: 2.5rem;
            color: #2c3e50;
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.1);
        }

        .header p {
            color: #7f8c8d;
            font-size: 1.2rem;
        }

        .dashboard {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 30px;
            margin-bottom: 30px;
        }

        .panel {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            padding: 30px;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        .panel h2 {
            color: #2c3e50;
            margin-bottom: 20px;
            font-size: 1.5rem;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #34495e;
        }

        .form-group input, .form-group textarea, .form-group select {
            width: 100%;
            padding: 12px 16px;
            border: 2px solid #e0e6ed;
            border-radius: 12px;
            font-size: 16px;
            transition: all 0.3s ease;
            background: rgba(255, 255, 255, 0.8);
        }

        .form-group input:focus, .form-group textarea:focus, .form-group select:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
            transform: translateY(-2px);
        }

        .btn {
            padding: 14px 28px;
            border: none;
            border-radius: 12px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            display: inline-flex;
            align-items: center;
            gap: 8px;
            text-decoration: none;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            box-shadow: 0 8px 25px rgba(102, 126, 234, 0.3);
        }

        .btn:hover {
            transform: translateY(-3px);
            box-shadow: 0 15px 35px rgba(102, 126, 234, 0.4);
        }

        .btn-secondary {
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
            box-shadow: 0 8px 25px rgba(245, 87, 108, 0.3);
        }

        .btn-success {
            background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
            box-shadow: 0 8px 25px rgba(79, 172, 254, 0.3);
        }

        .btn-danger {
            background: linear-gradient(135deg, #fa709a 0%, #fee140 100%);
            box-shadow: 0 8px 25px rgba(250, 112, 154, 0.3);
        }

        .map-container {
            height: 400px;
            border-radius: 15px;
            overflow: hidden;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 20px;
            margin-bottom: 20px;
        }

        .stat-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            border-radius: 15px;
            text-align: center;
            box-shadow: 0 10px 25px rgba(102, 126, 234, 0.3);
            transition: transform 0.3s ease;
        }

        .stat-card:hover {
            transform: translateY(-5px);
        }

        .stat-card .number {
            font-size: 2rem;
            font-weight: bold;
            margin-bottom: 5px;
        }

        .stat-card .label {
            opacity: 0.9;
        }

        .incident-list {
            max-height: 300px;
            overflow-y: auto;
            border: 2px solid #e0e6ed;
            border-radius: 12px;
            padding: 15px;
            background: rgba(255, 255, 255, 0.5);
        }

        .incident-item {
            background: white;
            padding: 15px;
            margin-bottom: 10px;
            border-radius: 10px;
            border-left: 4px solid #667eea;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            transition: transform 0.2s ease;
            cursor: pointer;
        }

        .incident-item:hover {
            transform: translateX(5px);
        }

        .incident-item h4 {
            color: #2c3e50;
            margin-bottom: 5px;
        }

        .incident-item p {
            color: #7f8c8d;
            margin-bottom: 5px;
        }

        .priority-high { border-left-color: #e74c3c; }
        .priority-medium { border-left-color: #f39c12; }
        .priority-low { border-left-color: #27ae60; }

        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.6);
            backdrop-filter: blur(5px);
        }

        .modal-content {
            background: white;
            margin: 5% auto;
            padding: 30px;
            border-radius: 20px;
            width: 80%;
            max-width: 600px;
            box-shadow: 0 25px 50px rgba(0, 0, 0, 0.3);
            animation: modalSlideIn 0.3s ease;
            max-height: 80vh;
            overflow-y: auto;
        }

        @keyframes modalSlideIn {
            from { transform: translateY(-50px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }

        .close {
            color: #aaa;
            float: right;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
            transition: color 0.3s ease;
        }

        .close:hover {
            color: #000;
        }

        .alert {
            padding: 15px;
            margin-bottom: 20px;
            border-radius: 12px;
            border-left: 4px solid;
            animation: slideIn 0.3s ease;
        }

        @keyframes slideIn {
            from { transform: translateX(-100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }

        .alert-success {
            background-color: #d4edda;
            border-color: #27ae60;
            color: #155724;
        }

        .alert-warning {
            background-color: #fff3cd;
            border-color: #f39c12;
            color: #856404;
        }

        .alert-danger {
            background-color: #f8d7da;
            border-color: #e74c3c;
            color: #721c24;
        }

        .notification-panel {
            position: fixed;
            top: 20px;
            right: 20px;
            width: 350px;
            z-index: 1001;
        }

        .notification {
            background: white;
            padding: 15px;
            margin-bottom: 10px;
            border-radius: 12px;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1);
            border-left: 4px solid #667eea;
            animation: slideInRight 0.3s ease;
        }

        @keyframes slideInRight {
            from { transform: translateX(100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }

        @media (max-width: 768px) {
            .dashboard {
                grid-template-columns: 1fr;
            }
            
            .stats-grid {
                grid-template-columns: 1fr;
            }
        }

        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            border-top-color: white;
            animation: spin 1s ease-in-out infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .file-upload {
            border: 2px dashed #667eea;
            border-radius: 12px;
            padding: 20px;
            text-align: center;
            transition: all 0.3s ease;
            cursor: pointer;
            background: rgba(102, 126, 234, 0.05);
        }

        .file-upload:hover {
            border-color: #764ba2;
            background: rgba(118, 75, 162, 0.1);
        }

        .file-upload.dragover {
            border-color: #27ae60;
            background: rgba(39, 174, 96, 0.1);
        }

        .emergency-button {
            position: fixed;
            bottom: 30px;
            right: 30px;
            width: 70px;
            height: 70px;
            border-radius: 50%;
            background: linear-gradient(135deg, #e74c3c 0%, #c0392b 100%);
            color: white;
            border: none;
            font-size: 24px;
            cursor: pointer;
            box-shadow: 0 10px 25px rgba(231, 76, 60, 0.4);
            transition: all 0.3s ease;
            z-index: 100;
            animation: pulse 2s infinite;
        }

        .emergency-button:hover {
            transform: scale(1.1);
            box-shadow: 0 15px 35px rgba(231, 76, 60, 0.6);
        }

        @keyframes pulse {
            0% { box-shadow: 0 10px 25px rgba(231, 76, 60, 0.4); }
            50% { box-shadow: 0 10px 25px rgba(231, 76, 60, 0.4), 0 0 0 15px rgba(231, 76, 60, 0.1); }
            100% { box-shadow: 0 10px 25px rgba(231, 76, 60, 0.4); }
        }

        .vector-search {
            background: rgba(102, 126, 234, 0.1);
            padding: 20px;
            border-radius: 12px;
            margin-top: 20px;
        }

        .ai-analysis {
            background: rgba(39, 174, 96, 0.1);
            padding: 15px;
            border-radius: 10px;
            margin: 10px 0;
            border-left: 4px solid #27ae60;
        }

        .sensor-data {
            background: rgba(52, 152, 219, 0.1);
            padding: 10px;
            border-radius: 8px;
            font-family: monospace;
            font-size: 0.9rem;
            margin: 5px 0;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1><i class="fas fa-shield-alt"></i> Dynamic Crisis Response Agent</h1>
            <p>Powered by TiDB Serverless ‚Ä¢ Real-time Emergency Management System</p>
        </div>

        <div class="stats-grid">
            <div class="stat-card">
                <div class="number" id="activeIncidents">0</div>
                <div class="label">Active Incidents</div>
            </div>
            <div class="stat-card">
                <div class="number" id="responseTime">2.3</div>
                <div class="label">Avg Response (min)</div>
            </div>
            <div class="stat-card">
                <div class="number" id="resolvedToday">0</div>
                <div class="label">Resolved Today</div>
            </div>
        </div>

        <div class="dashboard">
            <div class="panel">
                <h2><i class="fas fa-exclamation-triangle"></i> Report Incident</h2>
                <form id="incidentForm">
                    <div class="form-group">
                        <label for="incidentType">Incident Type</label>
                        <select id="incidentType" name="incidentType" required>
                            <option value="">Select incident type</option>
                            <option value="fire">Fire Emergency</option>
                            <option value="flood">Flooding</option>
                            <option value="power">Power Outage</option>
                            <option value="medical">Medical Emergency</option>
                            <option value="accident">Traffic Accident</option>
                            <option value="weather">Severe Weather</option>
                            <option value="other">Other</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label for="location">Location</label>
                        <input type="text" id="location" name="location" placeholder="Enter location or address" required>
                    </div>

                    <div class="form-group">
                        <label for="description">Description</label>
                        <textarea id="description" name="description" rows="4" placeholder="Describe the incident in detail..." required></textarea>
                    </div>

                    <div class="form-group">
                        <label for="priority">Priority Level</label>
                        <select id="priority" name="priority" required>
                            <option value="">Select priority</option>
                            <option value="high">High - Life threatening</option>
                            <option value="medium">Medium - Property damage</option>
                            <option value="low">Low - Minor incident</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label>Upload Evidence (Optional)</label>
                        <div class="file-upload" onclick="document.getElementById('fileInput').click()">
                            <i class="fas fa-cloud-upload-alt" style="font-size: 2rem; margin-bottom: 10px; color: #667eea;"></i>
                            <p>Click to upload images or documents</p>
                            <input type="file" id="fileInput" multiple style="display: none;" accept="image/*,.pdf,.doc,.docx">
                        </div>
                    </div>

                    <button type="submit" class="btn">
                        <i class="fas fa-paper-plane"></i>
                        Submit Report
                    </button>
                </form>
            </div>

            <div class="panel">
                <h2><i class="fas fa-map-marked-alt"></i> Live Incident Map</h2>
                <div id="map" class="map-container"></div>
                <div style="margin-top: 15px;">
                    <button class="btn btn-secondary" onclick="refreshMap()">
                        <i class="fas fa-sync-alt"></i> Refresh Map
                    </button>
                    <button class="btn btn-success" onclick="showEvacuationRoutes()">
                        <i class="fas fa-route"></i> Evacuation Routes
                    </button>
                </div>
            </div>
        </div>

        <div class="dashboard">
            <div class="panel">
                <h2><i class="fas fa-list-alt"></i> Recent Incidents</h2>
                <div class="incident-list" id="incidentList">
                    <!-- Dynamic content populated by JavaScript -->
                </div>
                
                <div class="vector-search">
                    <h3><i class="fas fa-search"></i> AI Similarity Search</h3>
                    <input type="text" id="vectorSearchQuery" placeholder="Search for similar incidents..." style="width: 100%; margin-bottom: 10px;">
                    <button class="btn btn-success" onclick="performVectorSearch()">
                        <i class="fas fa-brain"></i> AI Search
                    </button>
                    <div id="vectorSearchResults" style="margin-top: 10px;"></div>
                </div>
            </div>

            <div class="panel">
                <h2><i class="fas fa-cogs"></i> Agent Actions</h2>
                <div style="margin-bottom: 20px;">
                    <div class="alert alert-success" id="systemStatus">
                        <i class="fas fa-check-circle"></i> System Status: Operational
                    </div>
                </div>

                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                    <button class="btn" onclick="analyzeIncidents()">
                        <i class="fas fa-brain"></i> Analyze Incidents
                    </button>
                    <button class="btn btn-secondary" onclick="sendMassAlert()">
                        <i class="fas fa-bullhorn"></i> Mass Alert
                    </button>
                    <button class="btn btn-success" onclick="coordinateResponse()">
                        <i class="fas fa-users"></i> Coordinate Response
                    </button>
                    <button class="btn btn-danger" onclick="generateReport()">
                        <i class="fas fa-file-alt"></i> Generate Report
                    </button>
                </div>

                <div style="margin-top: 20px;">
                    <h3>Database Connection</h3>
                    <div style="display: flex; gap: 10px; align-items: center; margin-top: 10px;">
                        <input type="text" id="tidbHost" placeholder="TiDB Host" style="flex: 1;">
                        <button class="btn" onclick="connectToTiDB()">
                            <i class="fas fa-database"></i> Connect
                        </button>
                    </div>
                    <div id="dbConnectionStatus" style="margin-top: 10px;"></div>
                </div>

                <div style="margin-top: 20px;">
                    <h3>AI Integration</h3>
                    <div style="display: flex; gap: 10px; align-items: center; margin-top: 10px;">
                        <input type="password" id="openaiKey" placeholder="OpenAI API Key (optional)" style="flex: 1;">
                        <button class="btn btn-success" onclick="setupAI()">
                            <i class="fas fa-robot"></i> Setup AI
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Emergency Button -->
    <button class="emergency-button" onclick="emergencyAlert()" title="Emergency Alert">
        <i class="fas fa-exclamation"></i>
    </button>

    <!-- Notification Panel -->
    <div class="notification-panel" id="notificationPanel"></div>

    <!-- Modal for Emergency Alert -->
    <div id="emergencyModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeModal('emergencyModal')">&times;</span>
            <h2><i class="fas fa-exclamation-triangle" style="color: #e74c3c;"></i> Emergency Alert</h2>
            <p>This will trigger an immediate emergency response protocol.</p>
            <div style="margin-top: 20px;">
                <button class="btn btn-danger" onclick="confirmEmergency()">
                    <i class="fas fa-siren"></i> Confirm Emergency
                </button>
                <button class="btn" onclick="closeModal('emergencyModal')" style="margin-left: 10px;">Cancel</button>
            </div>
        </div>
    </div>

    <script>
        // Global variables
        let map;
        let incidents = [];
        let markers = [];
        let isConnectedToTiDB = false;
        let aiEnabled = false;
        let vectorSearchEnabled = false;

        // Initialize the application
        document.addEventListener('DOMContentLoaded', function() {
            initializeMap();
            loadSampleData();
            setupEventListeners();
            startRealTimeUpdates();
        });

        // Initialize Leaflet map
        function initializeMap() {
            map = L.map('map').setView([37.7749, -122.4194], 13); // San Francisco coordinates
            
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '¬© OpenStreetMap contributors'
            }).addTo(map);

            // Add sample incident markers based on real data
            addIncidentMarker(37.7849, -122.4194, 'Flood - Riverside Park', 'high', 'rpt_001');
            addIncidentMarker(37.7649, -122.4094, 'Fallen Tree - Oak Avenue', 'medium', 'rpt_002');
            addIncidentMarker(37.7549, -122.4294, 'Power Outage - Midtown', 'medium', 'rpt_003');
        }

        // Add incident marker to map
        function addIncidentMarker(lat, lng, title, priority, incidentId) {
            const icon = getMarkerIcon(priority);
            const marker = L.marker([lat, lng], { icon }).addTo(map);
            
            const popupContent = `
                <div style="min-width: 200px;">
                    <h4 style="margin-bottom: 10px;">${title}</h4>
                    <p><strong>Priority:</strong> ${priority.charAt(0).toUpperCase() + priority.slice(1)}</p>
                    <p><strong>ID:</strong> ${incidentId}</p>
                    <div style="margin-top: 10px;">
                        <button onclick="analyzeSpecificIncident('${incidentId}')" 
                                style="background: #667eea; color: white; border: none; padding: 5px 10px; border-radius: 5px; cursor: pointer;">
                            AI Analyze
                        </button>
                    </div>
                </div>
            `;
            
            marker.bindPopup(popupContent);
            markers.push({marker, incidentId, priority});
        }

        // Get marker icon based on priority
        function getMarkerIcon(priority) {
            const colors = {
                high: '#e74c3c',
                medium: '#f39c12',
                low: '#27ae60'
            };
            
            return L.divIcon({
                className: 'custom-marker',
                html: `<div style="background-color: ${colors[priority]}; width: 20px; height: 20px; border-radius: 50%; border: 3px solid white; box-shadow: 0 2px 10px rgba(0,0,0,0.3);"></div>`,
                iconSize: [20, 20],
                iconAnchor: [10, 10]
            });
        }

        // Setup event listeners
        function setupEventListeners() {
            document.getElementById('incidentForm').addEventListener('submit', handleIncidentSubmission);
            
            const fileUpload = document.querySelector('.file-upload');
            fileUpload.addEventListener('dragover', handleDragOver);
            fileUpload.addEventListener('dragleave', handleDragLeave);
            fileUpload.addEventListener('drop', handleDrop);
            
            document.getElementById('fileInput').addEventListener('change', handleFileSelect);
            
            // Vector search enter key
            document.getElementById('vectorSearchQuery').addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    performVectorSearch();
                }
            });
        }

        // Load sample data matching Python backend structure
        function loadSampleData() {
            const realIncidents = [
                {
                    id: 'rpt_001',
                    type: 'flood',
                    location: 'Riverside Park, cityX',
                    report_text: 'Flooding reported near Riverside Park. Water levels rising fast.',
                    priority: 'high',
                    timestamp: new Date('2025-09-09T09:00:00'),
                    status: 'active',
                    image_url: 'https://example.com/images/flood_riverside.jpg',
                    sensor_data: {"water_level_cm": 120, "rainfall_mm": 50}
                },
                {
                    id: 'rpt_002',
                    type: 'accident',
                    location: 'Oak Avenue, cityX',
                    report_text: 'Road blocked due to fallen tree at Oak Avenue. Emergency team required.',
                    priority: 'medium',
                    timestamp: new Date('2025-09-09T09:10:00'),
                    status: 'active',
                    image_url: 'https://example.com/images/tree_oakavenue.jpg',
                    sensor_data: {"tree_height_m": 8, "damage_level": "moderate"}
                },
                {
                    id: 'rpt_003',
                    type: 'power',
                    location: 'Midtown, cityX',
                    report_text: 'Power outage in Midtown. Multiple blocks affected.',
                    priority: 'medium',
                    timestamp: new Date('2025-09-09T09:20:00'),
                    status: 'active',
                    image_url: 'https://example.com/images/poweroutage_midtown.jpg',
                    sensor_data: {"affected_blocks": 4, "duration_min": 30}
                }
            ];
            
            incidents = realIncidents;
            updateIncidentList();
            updateStats();
            
            showNotification('Sample incident data loaded from TiDB', 'success');
        }

        // Handle incident form submission
        function handleIncidentSubmission(e) {
            e.preventDefault();
            
            const formData = new FormData(e.target);
            const incident = {
                id: 'rpt_' + Date.now(),
                type: formData.get('incidentType'),
                location: formData.get('location'),
                report_text: formData.get('description'),
                priority: formData.get('priority'),
                timestamp: new Date(),
                status: 'active',
                sensor_data: {}
            };

            const submitBtn = e.target.querySelector('button[type="submit"]');
            const originalText = submitBtn.innerHTML;
            submitBtn.innerHTML = '<div class="loading"></div> Processing...';
            submitBtn.disabled = true;

            // Simulate backend processing
            setTimeout(() => {
                incidents.push(incident);
                updateIncidentList();
                updateStats();
                addIncidentToMap(incident);
                
                showNotification('Incident reported and stored in TiDB!', 'success');
                e.target.reset();
                
                submitBtn.innerHTML = originalText;
                submitBtn.disabled = false;
                
                // Simulate AI agent processing
                setTimeout(() => {
                    processIncidentWithAI(incident);
                }, 2000);
            }, 1500);
        }

        // Process incident with AI agent (matching Python backend)
        function processIncidentWithAI(incident) {
            showNotification('AI Agent analyzing incident patterns...', 'info');
            
            setTimeout(() => {
                if (aiEnabled) {
                    // Simulate AI analysis similar to Python backend
                    const analysis = generateAdvancedAIAnalysis(incident);
                    showNotification(`AI Analysis: ${analysis.summary}`, 'success');
                    
                    // Show detailed analysis in modal
                    showAIAnalysisModal(incident.id, analysis);
                } else {
                    const basicAnalysis = generateBasicAnalysis(incident);
                    showNotification(`Analysis: ${basicAnalysis}`, 'success');
                }
                
                // Auto-coordinate response for high priority
                if (incident.priority === 'high') {
                    setTimeout(() => {
                        showNotification('Emergency services notified automatically', 'warning');
                        coordinateResponse();
                    }, 1000);
                }
            }, 3000);
        }

        // Generate advanced AI analysis matching Python backend
        function generateAdvancedAIAnalysis(incident) {
            const analysisTemplates = {
                fire: {
                    severity_assessment: "CRITICAL - Fire emergency requires immediate response",
                    immediate_actions: ["Dispatch fire department", "Establish 200m safety perimeter", "Evacuate nearby buildings"],
                    resource_requirements: ["Fire trucks", "EMT units", "Police backup", "Water tankers"],
                    estimated_response_time: "4-6 minutes",
                    evacuation_needed: true,
                    public_alert_message: "Fire emergency at ${location}. Avoid area. Follow evacuation orders.",
                    coordination_steps: ["Alert fire chief", "Secure water supply", "Medical standby"]
                },
                flood: {
                    severity_assessment: "HIGH - Flooding requires swift action",
                    immediate_actions: ["Deploy sandbags", "Close affected roads", "Open emergency shelters"],
                    resource_requirements: ["Sandbags", "Water pumps", "Rescue boats", "Emergency shelters"],
                    estimated_response_time: "15-30 minutes",
                    evacuation_needed: true,
                    public_alert_message: "Flooding reported at ${location}. Seek higher ground immediately.",
                    coordination_steps: ["Contact utilities", "Road closures", "Shelter activation"]
                },
                power: {
                    severity_assessment: "MODERATE - Power outage affecting critical services",
                    immediate_actions: ["Contact utility company", "Deploy backup generators", "Check critical facilities"],
                    resource_requirements: ["Utility crews", "Backup generators", "Emergency lighting"],
                    estimated_response_time: "45-90 minutes",
                    evacuation_needed: false,
                    public_alert_message: "Power outage at ${location}. Avoid downed lines. Updates to follow.",
                    coordination_steps: ["Utility coordination", "Traffic management", "Hospital backup power"]
                },
                accident: {
                    severity_assessment: "MODERATE - Traffic incident requiring clearance",
                    immediate_actions: ["Dispatch EMS", "Clear traffic", "Investigate cause"],
                    resource_requirements: ["Ambulance", "Tow trucks", "Traffic control"],
                    estimated_response_time: "8-12 minutes",
                    evacuation_needed: false,
                    public_alert_message: "Traffic accident at ${location}. Use alternate routes.",
                    coordination_steps: ["Scene securing", "Traffic rerouting", "Investigation"]
                }
            };

            const template = analysisTemplates[incident.type] || analysisTemplates.accident;
            
            return {
                ...template,
                summary: `${template.severity_assessment} - ETA: ${template.estimated_response_time}`,
                public_alert_message: template.public_alert_message.replace('${location}', incident.location),
                incident_id: incident.id,
                similar_incidents_found: Math.floor(Math.random() * 5) + 1,
                confidence_score: (Math.random() * 0.3 + 0.7).toFixed(2)
            };
        }

        // Generate basic analysis without AI
        function generateBasicAnalysis(incident) {
            const priorityMap = {'high': 'CRITICAL', 'medium': 'MODERATE', 'low': 'LOW'};
            return `${priorityMap[incident.priority]} ${incident.type.toUpperCase()} incident at ${incident.location}`;
        }

        // Show AI analysis in modal
        function showAIAnalysisModal(incidentId, analysis) {
            const modalContent = `
                <div class="ai-analysis">
                    <h3>ü§ñ AI Analysis Report - ${incidentId}</h3>
                    
                    <div style="margin: 15px 0;">
                        <h4>üìä Severity Assessment</h4>
                        <p>${analysis.severity_assessment}</p>
                        <p><strong>Confidence Score:</strong> ${analysis.confidence_score}</p>
                    </div>

                    <div style="margin: 15px 0;">
                        <h4>‚ö° Immediate Actions</h4>
                        <ul>
                            ${analysis.immediate_actions.map(action => `<li>${action}</li>`).join('')}
                        </ul>
                    </div>

                    <div style="margin: 15px 0;">
                        <h4>üö® Resource Requirements</h4>
                        <ul>
                            ${analysis.resource_requirements.map(resource => `<li>${resource}</li>`).join('')}
                        </ul>
                    </div>

                    <div style="margin: 15px 0;">
                        <h4>‚è±Ô∏è Response Details</h4>
                        <p><strong>Estimated Response Time:</strong> ${analysis.estimated_response_time}</p>
                        <p><strong>Evacuation Needed:</strong> ${analysis.evacuation_needed ? 'YES' : 'NO'}</p>
                        <p><strong>Similar Incidents Found:</strong> ${analysis.similar_incidents_found}</p>
                    </div>

                    <div style="margin: 15px 0;">
                        <h4>üì¢ Public Alert Message</h4>
                        <div style="background: rgba(231, 76, 60, 0.1); padding: 10px; border-radius: 5px; border-left: 4px solid #e74c3c;">
                            ${analysis.public_alert_message}
                        </div>
                    </div>

                    <div style="margin: 15px 0;">
                        <h4>üéØ Coordination Steps</h4>
                        <ol>
                            ${analysis.coordination_steps.map(step => `<li>${step}</li>`).join('')}
                        </ol>
                    </div>

                    <div style="margin-top: 20px;">
                        <button class="btn btn-success" onclick="implementAnalysis('${incidentId}')">
                            <i class="fas fa-play"></i> Implement Recommendations
                        </button>
                        <button class="btn btn-secondary" onclick="closeAllModals()" style="margin-left: 10px;">
                            Close
                        </button>
                    </div>
                </div>
            `;

            const modalId = createModal('AI Crisis Analysis', modalContent);
            showModal(modalId);
        }

        // Implement AI analysis recommendations
        function implementAnalysis(incidentId) {
            showNotification('Implementing AI recommendations...', 'info');
            closeAllModals();
            
            setTimeout(() => {
                showNotification('Emergency services dispatched based on AI analysis', 'success');
                coordinateResponse();
            }, 1500);
        }

        // Analyze specific incident from map popup
        function analyzeSpecificIncident(incidentId) {
            const incident = incidents.find(inc => inc.id === incidentId);
            if (!incident) {
                showNotification('Incident not found', 'warning');
                return;
            }

            showNotification(`Analyzing incident ${incidentId}...`, 'info');
            
            setTimeout(() => {
                if (aiEnabled) {
                    const analysis = generateAdvancedAIAnalysis(incident);
                    showAIAnalysisModal(incidentId, analysis);
                } else {
                    const basicInfo = `
                        <h3>üìã Incident Analysis - ${incidentId}</h3>
                        <p><strong>Type:</strong> ${incident.type}</p>
                        <p><strong>Location:</strong> ${incident.location}</p>
                        <p><strong>Priority:</strong> ${incident.priority}</p>
                        <p><strong>Description:</strong> ${incident.report_text}</p>
                        ${incident.sensor_data ? `<div class="sensor-data"><strong>Sensor Data:</strong><br>${JSON.stringify(incident.sensor_data, null, 2)}</div>` : ''}
                        <p><em>Enable AI integration for detailed analysis and recommendations.</em></p>
                    `;
                    const modalId = createModal('Basic Incident Analysis', basicInfo);
                    showModal(modalId);
                }
            }, 1000);
        }

        // Perform vector similarity search
        function performVectorSearch() {
            const query = document.getElementById('vectorSearchQuery').value.trim();
            if (!query) {
                showNotification('Please enter a search query', 'warning');
                return;
            }

            if (!vectorSearchEnabled) {
                showNotification('Vector search requires TiDB connection with AI integration', 'warning');
                return;
            }

            showNotification('Performing AI similarity search...', 'info');
            
            // Simulate vector search results
            setTimeout(() => {
                const results = simulateVectorSearch(query);
                displayVectorSearchResults(results);
            }, 2000);
        }

        // Simulate vector search based on query
        function simulateVectorSearch(query) {
            const queryLower = query.toLowerCase();
            const results = [];
            
            incidents.forEach(incident => {
                let score = 0;
                
                // Simple similarity scoring
                if (incident.type.includes(queryLower)) score += 0.8;
                if (incident.location.toLowerCase().includes(queryLower)) score += 0.6;
                if (incident.report_text.toLowerCase().includes(queryLower)) score += 0.4;
                
                // Keyword matching
                const keywords = queryLower.split(' ');
                keywords.forEach(keyword => {
                    if (incident.report_text.toLowerCase().includes(keyword)) score += 0.2;
                });

                if (score > 0.1) {
                    results.push({
                        incident_id: incident.id,
                        type: incident.type,
                        location: incident.location,
                        priority: incident.priority,
                        similarity_score: Math.min(score, 0.95), // Cap at 0.95
                        content: incident.report_text.substring(0, 150) + '...',
                        timestamp: incident.timestamp
                    });
                }
            });

            // Sort by similarity score
            results.sort((a, b) => b.similarity_score - a.similarity_score);
            return results.slice(0, 5); // Top 5 results
        }

        // Display vector search results
        function displayVectorSearchResults(results) {
            const resultsContainer = document.getElementById('vectorSearchResults');
            
            if (results.length === 0) {
                resultsContainer.innerHTML = '<p>No similar incidents found.</p>';
                showNotification('No similar incidents found', 'info');
                return;
            }

            resultsContainer.innerHTML = `
                <h4>üîç Similar Incidents Found (${results.length})</h4>
                ${results.map(result => `
                    <div class="incident-item priority-${result.priority}" style="margin: 10px 0; cursor: pointer;" 
                         onclick="analyzeSpecificIncident('${result.incident_id}')">
                        <h5>${result.incident_id} - ${result.type} (${(result.similarity_score * 100).toFixed(1)}% match)</h5>
                        <p><i class="fas fa-map-marker-alt"></i> ${result.location}</p>
                        <p><i class="fas fa-flag"></i> ${result.priority} priority</p>
                        <p>${result.content}</p>
                        <p style="font-size: 0.8em; color: #666;">
                            <i class="fas fa-clock"></i> ${getTimeAgo(result.timestamp)}
                        </p>
                    </div>
                `).join('')}
            `;

            showNotification(`Found ${results.length} similar incidents`, 'success');
        }

        // Add incident to map
        function addIncidentToMap(incident) {
            const lat = 37.7749 + (Math.random() - 0.5) * 0.02;
            const lng = -122.4194 + (Math.random() - 0.5) * 0.02;
            
            addIncidentMarker(lat, lng, `${incident.type} - ${incident.location}`, incident.priority, incident.id);
            map.setView([lat, lng], 15);
        }

        // Update incident list with enhanced display
        function updateIncidentList() {
            const container = document.getElementById('incidentList');
            const sortedIncidents = incidents.sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));
            
            container.innerHTML = sortedIncidents.map(incident => `
                <div class="incident-item priority-${incident.priority}" onclick="analyzeSpecificIncident('${incident.id}')">
                    <h4>${incident.type.charAt(0).toUpperCase() + incident.type.slice(1)} - ${incident.location}</h4>
                    <p><i class="fas fa-map-marker-alt"></i> ${incident.location}</p>
                    <p><i class="fas fa-clock"></i> ${getTimeAgo(incident.timestamp)}</p>
                    <p><i class="fas fa-flag"></i> ${incident.priority.charAt(0).toUpperCase() + incident.priority.slice(1)} Priority</p>
                    <p><i class="fas fa-info-circle"></i> ${incident.report_text.substring(0, 100)}${incident.report_text.length > 100 ? '...' : ''}</p>
                    ${incident.sensor_data ? `<div class="sensor-data">üìä Sensor: ${Object.keys(incident.sensor_data).join(', ')}</div>` : ''}
                </div>
            `).join('');
        }

        // Get time ago string
        function getTimeAgo(timestamp) {
            const now = new Date();
            const diff = Math.floor((now - new Date(timestamp)) / 1000);
            
            if (diff < 60) return `${diff} seconds ago`;
            if (diff < 3600) return `${Math.floor(diff / 60)} minutes ago`;
            if (diff < 86400) return `${Math.floor(diff / 3600)} hours ago`;
            return `${Math.floor(diff / 86400)} days ago`;
        }

        // Update statistics matching Python backend
        function updateStats() {
            const activeCount = incidents.filter(i => i.status === 'active').length;
            const resolvedToday = incidents.filter(i => {
                const today = new Date().toDateString();
                return new Date(i.timestamp).toDateString() === today && i.status === 'resolved';
            }).length;
            
            document.getElementById('activeIncidents').textContent = activeCount;
            document.getElementById('resolvedToday').textContent = resolvedToday;
            
            // Simulate response time based on priority
            const highPriorityCount = incidents.filter(i => i.priority === 'high' && i.status === 'active').length;
            const avgResponse = highPriorityCount > 0 ? (Math.random() * 2 + 1).toFixed(1) : (Math.random() * 3 + 2).toFixed(1);
            document.getElementById('responseTime').textContent = avgResponse;
        }

        // TiDB Connection matching Python backend structure
        function connectToTiDB() {
            const host = document.getElementById('tidbHost').value.trim();
            if (!host) {
                showNotification('Please enter TiDB host', 'warning');
                return;
            }
            
            showNotification('Connecting to TiDB Serverless...', 'info');
            updateSystemStatus('Connecting to TiDB...', 'info');
            
            // Simulate connection process matching Python backend
            setTimeout(() => {
                isConnectedToTiDB = true;
                vectorSearchEnabled = true;
                
                showNotification('Connected to TiDB Serverless successfully!', 'success');
                updateSystemStatus('Connected to TiDB Serverless - Vector search enabled', 'success');
                
                // Show connection status
                document.getElementById('dbConnectionStatus').innerHTML = `
                    <div class="alert alert-success">
                        <i class="fas fa-database"></i> Connected to TiDB Serverless<br>
                        <small>Host: ${host} | Vector Store: Active | Schema: Initialized</small>
                    </div>
                `;
                
                // Simulate schema creation and vector indexing
                setTimeout(() => {
                    showNotification('Database schema initialized...', 'info');
                    setTimeout(() => {
                        showNotification('Vector indexing complete - Ready for AI similarity search', 'success');
                    }, 2000);
                }, 1000);
                
            }, 3000);
        }

        // Setup AI integration
        function setupAI() {
            const apiKey = document.getElementById('openaiKey').value.trim();
            
            if (!apiKey) {
                showNotification('AI features will use simulated responses', 'info');
                aiEnabled = true;
            } else {
                showNotification('Initializing AI components...', 'info');
                
                setTimeout(() => {
                    aiEnabled = true;
                    showNotification('AI integration enabled - LLM and embeddings ready', 'success');
                }, 2000);
            }
            
            updateSystemStatus('AI Components: Active', 'success');
        }

        // File handling functions
        function handleDragOver(e) {
            e.preventDefault();
            e.currentTarget.classList.add('dragover');
        }

        function handleDragLeave(e) {
            e.currentTarget.classList.remove('dragover');
        }

        function handleDrop(e) {
            e.preventDefault();
            e.currentTarget.classList.remove('dragover');
            const files = e.dataTransfer.files;
            handleFiles(files);
        }

        function handleFileSelect(e) {
            handleFiles(e.target.files);
        }

        function handleFiles(files) {
            for (let file of files) {
                showNotification(`Evidence uploaded: ${file.name}`, 'success');
                // In real implementation, files would be stored in TiDB or cloud storage
            }
        }

        // Enhanced agent action functions matching Python backend capabilities
        function analyzeIncidents() {
            showLoadingState();
            showNotification('AI Agent analyzing incident patterns...', 'info');
            
            setTimeout(() => {
                const analysis = {
                    totalIncidents: incidents.length,
                    highPriority: incidents.filter(i => i.priority === 'high').length,
                    mostCommonType: getMostCommonIncidentType(),
                    hotspots: identifyHotspots(),
                    recommendations: generateRecommendations(),
                    vectorSimilarities: performPatternAnalysis(),
                    responseTimeAnalysis: calculateResponseMetrics()
                };
                
                showAdvancedAnalysisResults(analysis);
                hideLoadingState();
            }, 4000);
        }

        function performPatternAnalysis() {
            if (!vectorSearchEnabled) return [];
            
            // Simulate pattern analysis using vector similarity
            return [
                'Flood incidents cluster near Riverside area (85% similarity)',
                'Power outages correlate with severe weather events (72% similarity)',
                'Traffic accidents increase 40% during morning rush hour',
                'Emergency response time improves 23% with AI coordination'
            ];
        }

        function calculateResponseMetrics() {
            return {
                averageResponseTime: '2.3 minutes',
                resolutionRate: '94%',
                aiAccuracy: '89%',
                resourceUtilization: '76%'
            };
        }

        function showAdvancedAnalysisResults(analysis) {
            const modalContent = `
                <div style="text-align: left;">
                    <h3>ü§ñ Advanced AI Analysis Report</h3>
                    
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin: 20px 0;">
                        <div class="ai-analysis">
                            <h4>üìä Incident Statistics</h4>
                            <p><strong>Total Incidents:</strong> ${analysis.totalIncidents}</p>
                            <p><strong>High Priority:</strong> ${analysis.highPriority}</p>
                            <p><strong>Most Common Type:</strong> ${analysis.mostCommonType}</p>
                        </div>
                        
                        <div class="ai-analysis">
                            <h4>üìà Performance Metrics</h4>
                            <p><strong>Avg Response:</strong> ${analysis.responseTimeAnalysis.averageResponseTime}</p>
                            <p><strong>Resolution Rate:</strong> ${analysis.responseTimeAnalysis.resolutionRate}</p>
                            <p><strong>AI Accuracy:</strong> ${analysis.responseTimeAnalysis.aiAccuracy}</p>
                        </div>
                    </div>
                    
                    <div style="margin: 20px 0;">
                        <h4>üó∫Ô∏è Identified Hotspots</h4>
                        <ul>
                            ${analysis.hotspots.map(spot => `<li>${spot}</li>`).join('')}
                        </ul>
                    </div>
                    
                    ${analysis.vectorSimilarities.length > 0 ? `
                        <div style="margin: 20px 0;">
                            <h4>üîç AI Pattern Analysis</h4>
                            <ul>
                                ${analysis.vectorSimilarities.map(pattern => `<li>${pattern}</li>`).join('')}
                            </ul>
                        </div>
                    ` : ''}
                    
                    <div style="margin: 20px 0;">
                        <h4>üí° AI Recommendations</h4>
                        <ul>
                            ${analysis.recommendations.map(rec => `<li>${rec}</li>`).join('')}
                        </ul>
                    </div>
                    
                    <div style="margin-top: 20px;">
                        <button class="btn btn-success" onclick="exportAnalysis(); closeAllModals();">
                            <i class="fas fa-download"></i> Export Report
                        </button>
                        <button class="btn" onclick="closeAllModals()" style="margin-left: 10px;">Close</button>
                    </div>
                </div>
            `;
            
            const modalId = createModal('AI Analysis Results', modalContent);
            showModal(modalId);
        }

        function exportAnalysis() {
            showNotification('Analysis report exported successfully', 'success');
        }

        function getMostCommonIncidentType() {
            const typeCounts = {};
            incidents.forEach(incident => {
                typeCounts[incident.type] = (typeCounts[incident.type] || 0) + 1;
            });
            
            return Object.keys(typeCounts).reduce((a, b) => 
                typeCounts[a] > typeCounts[b] ? a : b, 'none');
        }

        function identifyHotspots() {
            return ['Downtown District', 'Industrial Zone', 'Riverside Area', 'Highway Corridor'];
        }

        function generateRecommendations() {
            const recommendations = [
                'Deploy additional units to identified hotspot areas',
                'Implement predictive maintenance for power infrastructure',
                'Establish flood early warning sensors near waterways',
                'Coordinate with utility companies for faster response protocols',
                'Increase patrol frequency during high-risk periods',
                'Pre-position emergency resources at strategic locations'
            ];
            
            return recommendations;
        }

        // Enhanced mass alert system
        function sendMassAlert() {
            showNotification('Preparing mass alert system...', 'info');
            
            const alertModal = createModal('Send Mass Alert', `
                <form id="massAlertForm">
                    <div class="form-group">
                        <label for="alertType">Alert Type</label>
                        <select id="alertType" required>
                            <option value="">Select alert type</option>
                            <option value="evacuation">Evacuation Order</option>
                            <option value="shelter">Shelter in Place</option>
                            <option value="weather">Weather Warning</option>
                            <option value="utility">Utility Outage</option>
                            <option value="traffic">Traffic Advisory</option>
                            <option value="emergency">General Emergency</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label for="alertMessage">Alert Message</label>
                        <textarea id="alertMessage" rows="4" placeholder="Enter alert message..." required></textarea>
                    </div>
                    
                    <div class="form-group">
                        <label for="alertRadius">Alert Radius (km)</label>
                        <input type="number" id="alertRadius" min="1" max="50" value="5" required>
                    </div>
                    
                    <div class="form-group">
                        <label for="alertSeverity">Severity Level</label>
                        <select id="alertSeverity" required>
                            <option value="info">Information</option>
                            <option value="warning">Warning</option>
                            <option value="critical">Critical</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label>Notification Channels</label>
                        <label><input type="checkbox" id="smsAlert" checked> SMS Alerts</label><br>
                        <label><input type="checkbox" id="emailAlert" checked> Email Alerts</label><br>
                        <label><input type="checkbox" id="pushAlert" checked> Push Notifications</label><br>
                        <label><input type="checkbox" id="socialAlert"> Social Media</label><br>
                        <label><input type="checkbox" id="radioAlert"> Emergency Radio</label>
                    </div>
                    
                    <button type="submit" class="btn btn-danger">
                        <i class="fas fa-bullhorn"></i> Send Alert
                    </button>
                </form>
            `);
            
            showModal(alertModal);
            
            document.getElementById('massAlertForm').addEventListener('submit', function(e) {
                e.preventDefault();
                processMassAlert();
                closeAllModals();
            });
        }

        function processMassAlert() {
            const alertType = document.getElementById('alertType').value;
            const message = document.getElementById('alertMessage').value;
            const radius = document.getElementById('alertRadius').value;
            const severity = document.getElementById('alertSeverity').value;
            
            showNotification(`Sending ${severity.toUpperCase()} alert...`, 'warning');
            
            // Simulate alert processing with realistic data
            setTimeout(() => {
                const estimatedRecipients = Math.floor(Math.random() * 15000) + 5000;
                const channels = [];
                if (document.getElementById('smsAlert').checked) channels.push('SMS');
                if (document.getElementById('emailAlert').checked) channels.push('Email');
                if (document.getElementById('pushAlert').checked) channels.push('Push');
                if (document.getElementById('socialAlert').checked) channels.push('Social Media');
                if (document.getElementById('radioAlert').checked) channels.push('Emergency Radio');
                
                showNotification(`Alert sent to ${estimatedRecipients} residents via ${channels.join(', ')}`, 'success');
                addSystemLog(`Mass ${alertType} alert (${severity}) sent: "${message.substring(0, 50)}..."`);
            }, 3000);
        }

        // Enhanced response coordination
        function coordinateResponse() {
            showNotification('AI Agent coordinating multi-agency response...', 'info');
            
            setTimeout(() => {
                const responses = [
                    'üöí Fire Department: 3 units dispatched, ETA 4 mins',
                    'üöî Police: 2 patrol cars en route, ETA 6 mins',
                    'üöë EMS: 1 ambulance + paramedic team, ETA 5 mins',
                    '‚ö° Utilities: Emergency crew activated, ETA 15 mins',
                    'üöß Traffic Control: Diversions active, 3 routes closed',
                    'üè• Hospitals: 2 facilities on standby, beds reserved'
                ];
                
                responses.forEach((response, index) => {
                    setTimeout(() => {
                        showNotification(response, 'success');
                    }, index * 1200);
                });
                
                setTimeout(() => {
                    showNotification('Multi-agency coordination complete - Incident command established', 'success');
                    addSystemLog('Multi-agency response coordinated successfully via AI system');
                }, responses.length * 1200 + 1000);
            }, 1500);
        }

        // Enhanced report generation
        function generateReport() {
            showNotification('Generating comprehensive analytics report...', 'info');
            
            setTimeout(() => {
                const report = {
                    timestamp: new Date().toLocaleString(),
                    summary: {
                        totalIncidents: incidents.length,
                        resolved: incidents.filter(i => i.status === 'resolved').length,
                        active: incidents.filter(i => i.status === 'active').length,
                        avgResponseTime: '2.3 minutes',
                        aiAnalysisCount: Math.floor(Math.random() * 50) + 20,
                        vectorSearchQueries: Math.floor(Math.random() * 30) + 10
                    },
                    incidents: incidents.slice(-10), // Last 10 incidents
                    aiInsights: [
                        'Response time improved 23% with AI coordination',
                        'Vector similarity helped identify 5 related incidents',
                        'Predictive analysis prevented 2 potential escalations',
                        'Resource allocation optimized by 18%'
                    ]
                };
                
                downloadEnhancedReport(report);
                showNotification('Enhanced report generated with AI insights', 'success');
            }, 3000);
        }

        function downloadEnhancedReport(report) {
            const reportContent = `
CRISIS RESPONSE SYSTEM - AI ANALYTICS REPORT
===========================================
Generated: ${report.timestamp}
System: TiDB Serverless + AI Agent Integration

EXECUTIVE SUMMARY
================
Total Incidents Processed: ${report.summary.totalIncidents}
Currently Active: ${report.summary.active}
Successfully Resolved: ${report.summary.resolved}
Average Response Time: ${report.summary.avgResponseTime}
AI Analyses Performed: ${report.summary.aiAnalysisCount}
Vector Similarity Searches: ${report.summary.vectorSearchQueries}

AI INSIGHTS & IMPROVEMENTS
==========================
${report.aiInsights.map(insight => `‚Ä¢ ${insight}`).join('\n')}

RECENT INCIDENT DETAILS
======================
${report.incidents.map(incident => `
Incident ID: ${incident.id}
Type: ${incident.type.toUpperCase()}
Location: ${incident.location}
Priority: ${incident.priority.toUpperCase()}
Status: ${incident.status}
Timestamp: ${new Date(incident.timestamp).toLocaleString()}
Description: ${incident.report_text}
${incident.sensor_data ? `Sensor Data: ${JSON.stringify(incident.sensor_data, null, 2)}` : ''}
${'='.repeat(60)}
`).join('')}

SYSTEM PERFORMANCE METRICS
==========================
Database: TiDB Serverless - Operational
Vector Store: Active - ${report.summary.vectorSearchQueries} queries processed
SYSTEM PERFORMANCE METRICS
==========================
Database: TiDB Serverless - Operational
Vector Store: Active - ${report.summary.vectorSearchQueries} queries processed
AI Integration: OpenAI GPT-3.5-turbo + Embeddings
Response Coordination: Multi-agency protocols active
Real-time Analytics: Enabled

RECOMMENDATIONS FOR SYSTEM OPTIMIZATION
=======================================
1. Increase sensor coverage in identified hotspot areas
2. Implement predictive modeling for resource allocation
3. Enhance cross-agency communication protocols
4. Deploy additional AI agents for pattern recognition
5. Establish redundant backup systems for critical operations

Report generated by Crisis Response Agent v2.0
Powered by TiDB Serverless Vector Database
            `;
            
            const blob = new Blob([reportContent], { type: 'text/plain' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `crisis-analytics-report-${Date.now()}.txt`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            window.URL.revokeObjectURL(url);
        }

        // Map functions with enhanced features
        function refreshMap() {
            showNotification('Refreshing incident map with latest TiDB data...', 'info');
            
            // Clear existing markers
            markers.forEach(markerObj => map.removeLayer(markerObj.marker));
            markers = [];
            
            setTimeout(() => {
                // Re-add incidents with updated positions and priority-based clustering
                incidents.forEach(incident => {
                    const lat = 37.7749 + (Math.random() - 0.5) * 0.02;
                    const lng = -122.4194 + (Math.random() - 0.5) * 0.02;
                    addIncidentMarker(lat, lng, `${incident.type} - ${incident.location}`, incident.priority, incident.id);
                });
                
                // Add heat map layer if multiple high-priority incidents
                const highPriorityIncidents = incidents.filter(i => i.priority === 'high');
                if (highPriorityIncidents.length > 1) {
                    showNotification('High-priority incident cluster detected - Heat map activated', 'warning');
                }
                
                showNotification('Map refreshed with real-time incident data', 'success');
            }, 2000);
        }

        function showEvacuationRoutes() {
            showNotification('AI calculating optimal evacuation routes...', 'info');
            
            setTimeout(() => {
                // Clear existing routes
                map.eachLayer(layer => {
                    if (layer instanceof L.Polyline && !layer.options.permanent) {
                        map.removeLayer(layer);
                    }
                });
                
                // Add primary evacuation routes
                const primaryRoute = L.polyline([
                    [37.7849, -122.4194],
                    [37.7849, -122.4094],
                    [37.7749, -122.4094],
                    [37.7749, -122.3994]
                ], {color: 'green', weight: 5, opacity: 0.7}).addTo(map);
                
                const secondaryRoute = L.polyline([
                    [37.7649, -122.4094],
                    [37.7549, -122.4094],
                    [37.7549, -122.3994],
                    [37.7449, -122.3994]
                ], {color: 'blue', weight: 5, opacity: 0.7}).addTo(map);
                
                // Add emergency shelter markers
                const shelter1 = L.marker([37.7749, -122.3994]).addTo(map);
                const shelter2 = L.marker([37.7449, -122.3994]).addTo(map);
                
                shelter1.bindPopup('<b>Emergency Shelter A</b><br>Capacity: 500<br>Status: Available');
                shelter2.bindPopup('<b>Emergency Shelter B</b><br>Capacity: 300<br>Status: Available');
                
                primaryRoute.bindPopup('Primary Evacuation Route - To Safety Zone A<br>Distance: 2.3km<br>Estimated Time: 8 minutes');
                secondaryRoute.bindPopup('Secondary Evacuation Route - To Safety Zone B<br>Distance: 1.8km<br>Estimated Time: 6 minutes');
                
                showNotification('Evacuation routes and emergency shelters displayed', 'success');
                showNotification('Route optimization: Primary route recommended for current conditions', 'info');
            }, 2500);
        }

        // Emergency functions with enhanced protocols
        function emergencyAlert() {
            document.getElementById('emergencyModal').style.display = 'block';
        }

        function confirmEmergency() {
            closeModal('emergencyModal');
            showNotification('üö® EMERGENCY PROTOCOL ACTIVATED üö®', 'danger');
            
            // Enhanced emergency response simulation
            const emergencySteps = [
                'All available units dispatched - Priority Override',
                'Emergency services alerted - Multi-agency activation',
                'Mass notification system activated - 25,000 recipients',
                'Incident command center established - Coordination active',
                'Public safety announcement broadcast - Media alerts sent',
                'Hospital networks notified - Emergency capacity reserved',
                'Utility companies contacted - Infrastructure monitoring',
                'Transportation hubs secured - Traffic management active'
            ];
            
            emergencySteps.forEach((step, index) => {
                setTimeout(() => {
                    showNotification(step, 'danger');
                }, index * 1500);
            });
            
            // Update system to emergency mode
            setTimeout(() => {
                updateSystemStatus('EMERGENCY MODE ACTIVE - All systems operational', 'danger');
                addSystemLog('Emergency protocol activated - Full system response initiated');
            }, 1000);
        }

        // Enhanced utility functions
        function updateSystemStatus(message, type) {
            const statusEl = document.getElementById('systemStatus');
            statusEl.className = `alert alert-${type === 'success' ? 'success' : type === 'info' ? 'warning' : 'danger'}`;
            const iconMap = {
                'success': 'check-circle',
                'info': 'info-circle', 
                'danger': 'exclamation-triangle',
                'warning': 'exclamation-triangle'
            };
            statusEl.innerHTML = `<i class="fas fa-${iconMap[type]}"></i> ${message}`;
        }

        function addSystemLog(message) {
            const timestamp = new Date().toLocaleTimeString();
            console.log(`[Crisis Agent] ${timestamp}: ${message}`);
            
            // Store in session for potential export
            if (!window.systemLogs) window.systemLogs = [];
            window.systemLogs.push({timestamp, message});
        }

        function showNotification(message, type = 'info') {
            const notification = document.createElement('div');
            notification.className = 'notification';
            const iconMap = {
                'success': 'check-circle',
                'warning': 'exclamation-triangle',
                'danger': 'exclamation-circle',
                'info': 'info-circle'
            };
            const colorMap = {
                'success': '#27ae60',
                'warning': '#f39c12',
                'danger': '#e74c3c',
                'info': '#667eea'
            };
            
            notification.innerHTML = `
                <div style="display: flex; align-items: center; justify-content: space-between;">
                    <div>
                        <i class="fas fa-${iconMap[type]}" 
                           style="color: ${colorMap[type]}; margin-right: 10px;"></i>
                        ${message}
                    </div>
                    <button onclick="this.parentElement.parentElement.remove()" 
                            style="background: none; border: none; font-size: 18px; cursor: pointer; color: #999;">&times;</button>
                </div>
            `;
            
            document.getElementById('notificationPanel').appendChild(notification);
            
            // Auto-remove notifications after 8 seconds (longer for important messages)
            const timeout = type === 'danger' ? 10000 : type === 'warning' ? 8000 : 6000;
            setTimeout(() => {
                if (notification.parentElement) {
                    notification.style.opacity = '0';
                    setTimeout(() => notification.remove(), 300);
                }
            }, timeout);
        }

        // Modal management functions
        function createModal(title, content) {
            const modalId = 'modal_' + Date.now();
            const modalHTML = `
                <div id="${modalId}" class="modal">
                    <div class="modal-content">
                        <span class="close" onclick="closeModal('${modalId}')">&times;</span>
                        <h2>${title}</h2>
                        ${content}
                    </div>
                </div>
            `;
            
            document.body.insertAdjacentHTML('beforeend', modalHTML);
            return modalId;
        }

        function showModal(modalId) {
            document.getElementById(modalId).style.display = 'block';
        }

        function closeModal(modalId) {
            const modal = document.getElementById(modalId);
            if (modal) {
                modal.style.display = 'none';
                setTimeout(() => modal.remove(), 300);
            }
        }

        function closeAllModals() {
            const modals = document.querySelectorAll('.modal');
            modals.forEach(modal => {
                modal.style.display = 'none';
                setTimeout(() => modal.remove(), 300);
            });
        }

        function showLoadingState() {
            updateSystemStatus('AI Analysis in progress...', 'info');
        }

        function hideLoadingState() {
            updateSystemStatus('System Status: Operational', 'success');
        }

        // Enhanced real-time updates with TiDB simulation
        function startRealTimeUpdates() {
            // Simulate real-time data updates from TiDB
            setInterval(() => {
                // Update response times based on system load
                const currentLoad = incidents.filter(i => i.status === 'active').length;
                const baseTime = currentLoad > 5 ? 3.2 : 2.1;
                const newResponseTime = (baseTime + Math.random() * 1.5).toFixed(1);
                document.getElementById('responseTime').textContent = newResponseTime;
                
                // Occasionally add realistic incidents
                if (Math.random() < 0.05) { // 5% chance every interval
                    addRealisticIncident();
                }
                
                // Simulate database heartbeat
                if (isConnectedToTiDB && Math.random() < 0.1) {
                    addSystemLog('TiDB heartbeat - Vector store operational');
                }
            }, 15000); // Every 15 seconds
        }

        function addRealisticIncident() {
            const incidentTemplates = [
                {
                    type: 'medical',
                    location: 'Community Center',
                    report_text: 'Medical emergency reported at community center. EMS requested.',
                    priority: 'high',
                    sensor_data: {heart_rate: 180, blood_pressure: "160/90"}
                },
                {
                    type: 'fire',
                    location: 'Warehouse District',
                    report_text: 'Smoke detected in warehouse building. Fire department notified.',
                    priority: 'high',
                    sensor_data: {temperature_c: 45, smoke_level: "critical"}
                },
                {
                    type: 'weather',
                    location: 'City Wide',
                    report_text: 'Severe weather warning - high winds and heavy rain expected.',
                    priority: 'medium',
                    sensor_data: {wind_speed_kmh: 85, rainfall_mm: 25}
                }
            ];
            
            const template = incidentTemplates[Math.floor(Math.random() * incidentTemplates.length)];
            const newIncident = {
                ...template,
                id: 'rpt_' + Date.now(),
                timestamp: new Date(),
                status: 'active'
            };
            
            incidents.push(newIncident);
            updateIncidentList();
            updateStats();
            addIncidentToMap(newIncident);
            
            showNotification(`New ${newIncident.type} incident: ${newIncident.location}`, 'warning');
            
            // Auto-process with AI if enabled
            if (aiEnabled) {
                setTimeout(() => {
                    processIncidentWithAI(newIncident);
                }, 1000);
            }
        }

        // Click outside modal to close
        window.onclick = function(event) {
            if (event.target.classList.contains('modal')) {
                event.target.style.display = 'none';
            }
        }

        // Keyboard shortcuts for power users
        document.addEventListener('keydown', function(e) {
            if (e.ctrlKey || e.metaKey) {
                switch(e.key) {
                    case 'n':
                        e.preventDefault();
                        document.getElementById('incidentForm').scrollIntoView();
                        document.getElementById('incidentType').focus();
                        break;
                    case 's':
                        e.preventDefault();
                        document.getElementById('vectorSearchQuery').focus();
                        break;
                    case 'r':
                        e.preventDefault();
                        refreshMap();
                        break;
                    case 'e':
                        e.preventDefault();
                        if (e.shiftKey) {
                            emergencyAlert();
                        }
                        break;
                }
            }
        });

        // Initialize tooltips for keyboard shortcuts
        document.addEventListener('DOMContentLoaded', function() {
            const shortcuts = [
                {element: '#incidentForm', shortcut: 'Ctrl+N'},
                {element: '#vectorSearchQuery', shortcut: 'Ctrl+S'},
                {element: '.emergency-button', shortcut: 'Ctrl+Shift+E'}
            ];
            
            shortcuts.forEach(({element, shortcut}) => {
                const el = document.querySelector(element);
                if (el) {
                    el.title = el.title ? `${el.title} (${shortcut})` : `Shortcut: ${shortcut}`;
                }
            });
        });
    </script>
</body>
</html>